<!-- 创建角色 - AI对话页面 -->
<view class="page-container">
  <!-- 顶部导航（固定） -->
  <view class="navbar">
    <view class="nav-back" bindtap="onBack">
      <t-icon name="chevron-left" size="40rpx" color="#374151" />
    </view>
    <text class="navbar-title">创建角色</text>
  </view>
  
  <!-- 聊天消息区域 -->
  <scroll-view 
    class="chat-container" 
    scroll-y 
    enhanced 
    show-scrollbar="{{false}}"
    scroll-top="{{scrollTop}}"
  >
    <view class="message-list"
      style="padding-bottom: {{keyboardHeight > 0 ? (keyboardHeight + inputContainerHeight + 16) + 'px' : (inputContainerHeight +8 + 32) + 'rpx'}}">
      <!-- 消息列表 -->
      <view 
        wx:for="{{messages}}" 
        wx:key="id" 
        id="msg-{{item.id}}"
        class="message {{item.role === 'ai' ? 'message-ai' : 'message-user'}} {{item.animate ? 'message-animate' : ''}}"
      >
        <view class="message-avatar">
          <t-avatar 
            wx:if="{{item.role === 'user' && userAvatar}}" 
            image="{{userAvatar}}" 
            size="72rpx" 
          />
          <text wx:elif="{{item.role === 'user'}}">我</text>
          <text wx:else>AI</text>
        </view>
        <view class="message-content">
          <!-- 消息气泡部分 -->
          <view class="message-bubble">
            <view wx:if="{{item.pending}}" class="typing-row">
              <view class="pending-text-wrap" wx:if="{{item.pendingText}}" style="animation: text-fade 0.4s ease-in-out">
                <text class="pending-text">{{item.pendingText}}</text>
              </view>
              <view wx:else class="pending-text-wrap">
                <text class="pending-text">正在思考中</text>
              </view>
              <t-loading theme="dots" size="28rpx" />
            </view>
            <!-- 使用 Markdown 渲染 AI 消息，用户消息保持纯文本 -->
            <t-chat-markdown 
              wx:elif="{{item.role === 'ai'}}"
              content="{{item.content}}"
            />
            <text wx:else>{{item.content}}</text>
          </view>
          <!-- 图片消息 -->
          <view wx:if="{{item.images && item.images.length > 0}}" class="message-images">
            <t-image 
              wx:for="{{item.images}}" 
              wx:for-item="img" 
              wx:key="*this"
              src="{{img}}" 
              class="message-image"
              mode="aspectFill"
              bindtap="onPreviewImage"
              data-url="{{img}}"
            />
          </view>
        </view>
      </view>
      
    </view>
    
    <!-- 底部占位，防止输入栏遮挡 -->
    <view class="bottom-placeholder" style="height: {{keyboardHeight > 0 ? (keyboardHeight + 120) + 'px' : '200rpx'}}"></view>
  </scroll-view>
  
  <!-- 悬浮确认按钮 -->
  <view 
    class="floating-confirm-btn" 
    bindtap="onConfirm"
    style="bottom: {{keyboardHeight > 0 ? (keyboardHeight + inputContainerHeight + 16) + 'px' : (inputContainerHeight +8 + 32) + 'px'}}"
  >
    <t-icon name="check" size="48rpx" color="#fff" />
  </view>

  <!-- 底部输入栏 -->
  <view class="input-container" style="bottom: {{keyboardHeight > 0 ? keyboardHeight + 'px' : '32rpx'}}">
    <!-- 上传按钮 -->
    <view class="action-btn" bindtap="onChooseImage">
      <t-icon name="add" size="40rpx" color="#666" />
      <view class="image-badge" wx:if="{{pendingImage}}">1</view>
    </view>
    
    <!-- 输入框 -->
    <view class="input-wrapper">
      <textarea
        class="chat-input"
        placeholder="输入你的想法..."
        value="{{inputValue}}"
        bindinput="onInput"
        bindconfirm="onSend"
        bindfocus="onInputFocus"
        bindblur="onInputBlur"
        bindkeyboardheightchange="onKeyboardChange"
        bindlinechange="onLineChange"
       
        adjust-position="{{false}}"
        fixed
        show-confirm-bar="{{false}}"
        maxlength="-1"
        cursor-spacing="16"
        hold-keyboard
        disable-default-padding
        auto-height
      />
    </view>
    
    <!-- 发送按钮 -->
    <view class="send-btn" bindtap="onSend">
      <t-icon name="arrow-up" size="36rpx" color="#fff" />
    </view>
  </view>

  <!-- 隐藏的 canvas 用于图片压缩 -->
  <canvas 
    type="2d" 
    id="compressCanvas" 
    style="position:absolute;top:-9999px;left:-9999px;width:300px;height:300px;"
  />
</view>
