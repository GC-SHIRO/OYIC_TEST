<!-- é¢„è§ˆè§’è‰²å¡é¡µé¢ -->
<view class="page-container" capture-bind:touchstart="handleHideToast">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="navbar">
    <view class="nav-back" bindtap="onBack">
      <t-icon name="chevron-left" size="40rpx" color="#374151" />
    </view>
    <text class="navbar-title">é¢„è§ˆè§’è‰²å¡</text>
    <view class="nav-placeholder"></view>
  </view>
  
  <!-- å†…å®¹åŒºåŸŸ -->
  <scroll-view class="content-container" scroll-y enhanced show-scrollbar="{{false}}">
    <!-- åŠ è½½ä¸­ -->
    <view wx:if="{{loading}}" class="loading-container">
      <t-loading theme="circular" size="80rpx" />
      <text class="loading-text">æ­£åœ¨ç”Ÿæˆè§’è‰²å¡...</text>
    </view>
    
    <block wx:else>
      <view class="preview-tabs">
        <view class="preview-tab {{activeTab === 'profile' ? 'preview-tab--active' : ''}}" data-tab="profile" bindtap="onSwitchTab">è§’è‰²ä¿¡æ¯</view>
        <view class="preview-tab {{activeTab === 'gallery' ? 'preview-tab--active' : ''}}" data-tab="gallery" bindtap="onSwitchTab">è§’è‰²ç”»å»Š</view>
      </view>

      <block wx:if="{{activeTab === 'profile'}}">
      <!-- è§’è‰²å¡ç‰‡é¢„è§ˆ -->
      <view class="character-preview">
        <!-- å¤´éƒ¨ï¼šå§“å -->
        <view class="preview-header">
          <view class="preview-header-tools">
            <view class="section-edit-btn intro-edit-btn" bindtap="onToggleEdit" data-section="introduction">{{editingSection === 'introduction' ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘ç®€ä»‹'}}</view>
          </view>
          <view class="character-name">{{character.name}}</view>
          <block wx:if="{{editingSection === 'introduction'}}">
            <textarea class="long-text-input input-paragraph" value="{{character.introduction}}" data-path="introduction" bindinput="onFieldInput" placeholder="è¯·è¾“å…¥ç®€ä»‹" />
          </block>
          <text wx:else class="character-intro">{{character.introduction}}</text>
        </view>
        
        <view class="preview-body">
          <!-- åŸºæœ¬ä¿¡æ¯ -->
          <view class="info-section">
            <view class="section-header">
              <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
              <view class="section-edit-btn" bindtap="onToggleEdit" data-section="basicInfo">{{editingSection === 'basicInfo' ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘'}}</view>
            </view>
            <view class="section-content">
              <view class="info-item">
                <text class="info-label">å§“åï¼š</text>
                <block wx:if="{{editingSection === 'basicInfo'}}"><input class="info-input input-short {{focusedInputPath === 'name' ? 'input-focused' : ''}}" value="{{character.name}}" data-path="name" bindinput="onFieldInput" bindfocus="onInputFocus" bindblur="onInputBlur" placeholder="è¯·è¾“å…¥å§“å" /></block>
                <text wx:else class="info-value">{{character.name}}</text>
              </view>
              <view class="info-item">
                <text class="info-label">æ€§åˆ«ï¼š</text>
                <block wx:if="{{editingSection === 'basicInfo'}}"><input class="info-input input-short {{focusedInputPath === 'gender' ? 'input-focused' : ''}}" value="{{character.gender}}" data-path="gender" bindinput="onFieldInput" bindfocus="onInputFocus" bindblur="onInputBlur" placeholder="è¯·è¾“å…¥æ€§åˆ«" /></block>
                <text wx:else class="info-value">{{character.gender}}</text>
              </view>
              <view class="info-item">
                <text class="info-label">æ˜Ÿåº§ï¼š</text>
                <block wx:if="{{editingSection === 'basicInfo'}}"><input class="info-input input-short {{focusedInputPath === 'constellation' ? 'input-focused' : ''}}" value="{{character.constellation}}" data-path="constellation" bindinput="onFieldInput" bindfocus="onInputFocus" bindblur="onInputBlur" placeholder="è¯·è¾“å…¥æ˜Ÿåº§" /></block>
                <text wx:else class="info-value">{{character.constellation}}</text>
              </view>
              <view class="info-item">
                <text class="info-label">ç”Ÿæ—¥ï¼š</text>
                <block wx:if="{{editingSection === 'basicInfo'}}"><input class="info-input input-short {{focusedInputPath === 'birthday' ? 'input-focused' : ''}}" value="{{character.birthday}}" data-path="birthday" bindinput="onFieldInput" bindfocus="onInputFocus" bindblur="onInputBlur" placeholder="è¯·è¾“å…¥ç”Ÿæ—¥" /></block>
                <text wx:else class="info-value">{{character.birthday}}</text>
              </view>
              <view class="info-item">
                <text class="info-label">ç‰©ç§ï¼š</text>
                <block wx:if="{{editingSection === 'basicInfo'}}"><input class="info-input input-short {{focusedInputPath === 'species' ? 'input-focused' : ''}}" value="{{character.species}}" data-path="species" bindinput="onFieldInput" bindfocus="onInputFocus" bindblur="onInputBlur" placeholder="è¯·è¾“å…¥ç‰©ç§" /></block>
                <text wx:else class="info-value">{{character.species}}</text>
              </view>
            </view>
          </view>
          
          <view class="section-divider"></view>
          
          <!-- æ€§æ ¼æ ‡ç­¾ -->
          <view class="info-section">
            <view class="section-header">
              <view class="section-title">æ€§æ ¼æ ‡ç­¾</view>
              <view class="section-edit-btn" bindtap="onToggleEdit" data-section="personalityTags">{{editingSection === 'personalityTags' ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘'}}</view>
            </view>
            <view class="personality-tags">
              <block wx:if="{{editingSection === 'personalityTags'}}">
                <view wx:for="{{character.personalityTags}}" wx:key="*this" class="input-wrapper {{focusedTagIndex === index ? 'input-wrapper--focused' : ''}}">
                  <input class="tag-input" value="{{item}}" data-path="personalityTags" data-index="{{index}}" bindinput="onFieldInput" bindfocus="onTagFocus" bindblur="onTagBlur" placeholder="æ ‡ç­¾" />
                </view>
                <view class="personality-tag-add" bindtap="onAddPersonalityTag">+</view>
              </block>
              <block wx:else>
                <view wx:for="{{character.personalityTags}}" wx:key="*this" class="personality-tag">{{item}}</view>
              </block>
            </view>
          </view>
          
          <view class="section-divider"></view>
          
          <!-- å¤–è§‚æè¿° -->
          <view class="info-section">
            <view class="section-header">
              <view class="section-title">å¤–è§‚æè¿°</view>
              <view class="section-edit-btn" bindtap="onToggleEdit" data-section="appearance">{{editingSection === 'appearance' ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘'}}</view>
            </view>
            <view class="appearance-attrs">
              <!-- å†…ç½®å±æ€§ï¼šå‘è‰² -->
              <view class="appearance-attr">
                <view class="attr-color-dot hair-dot"></view>
                <text class="attr-label">å‘è‰²</text>
                <block wx:if="{{editingSection === 'appearance'}}">
                  <input class="attr-input input-short {{focusedInputPath === 'appearance.hairColor' ? 'input-focused' : ''}}" value="{{character.appearance.hairColor}}" data-path="appearance.hairColor" bindinput="onFieldInput" bindfocus="onInputFocus" bindblur="onInputBlur" placeholder="å‘è‰²" />
                  <view class="attr-lock-btn attr-lock-fixed"><text class="attr-lock-icon">ğŸ”’</text></view>
                </block>
                <text wx:else class="attr-value">{{character.appearance.hairColor}}</text>
              </view>
              <!-- å†…ç½®å±æ€§ï¼šç³è‰² -->
              <view class="appearance-attr">
                <view class="attr-color-dot hair-dot"></view>
                <text class="attr-label">ç³è‰²</text>
                <block wx:if="{{editingSection === 'appearance'}}">
                  <input class="attr-input input-short {{focusedInputPath === 'appearance.eyeColor' ? 'input-focused' : ''}}" value="{{character.appearance.eyeColor}}" data-path="appearance.eyeColor" bindinput="onFieldInput" bindfocus="onInputFocus" bindblur="onInputBlur" placeholder="ç³è‰²" />
                  <view class="attr-lock-btn attr-lock-fixed"><text class="attr-lock-icon">ğŸ”’</text></view>
                </block>
                <text wx:else class="attr-value">{{character.appearance.eyeColor}}</text>
              </view>
              <!-- è‡ªå®šä¹‰å±æ€§ -->
              <block wx:for="{{character.appearance.customAttrs}}" wx:key="index" wx:for-item="attr" wx:for-index="attrIdx">
                <view class="appearance-attr">
                  <block wx:if="{{editingSection === 'appearance'}}">
                    <view class="attr-lock-btn" bindtap="onToggleAppearanceAttrLock" data-index="{{attrIdx}}">
                      <text class="attr-lock-icon">{{attr.locked ? 'ğŸ”’' : 'ğŸ”“'}}</text>
                    </view>
                    <block wx:if="{{attr.locked}}">
                      <text class="attr-label-text">{{attr.label || 'å±æ€§å'}}</text>
                    </block>
                    <block wx:else>
                      <input class="attr-label-input input-short {{focusedInputPath === 'appearance.customAttrs-' + attrIdx + '-label' ? 'input-focused' : ''}}" value="{{attr.label}}" data-path="appearance.customAttrs" data-index="{{attrIdx}}" data-subfield="label" bindinput="onFieldInput" bindfocus="onInputFocus" bindblur="onInputBlur" placeholder="å±æ€§å" />
                    </block>
                    <input class="attr-input attr-value-input input-short {{focusedInputPath === 'appearance.customAttrs-' + attrIdx + '-value' ? 'input-focused' : ''}}" value="{{attr.value}}" data-path="appearance.customAttrs" data-index="{{attrIdx}}" data-subfield="value" bindinput="onFieldInput" bindfocus="onInputFocus" bindblur="onInputBlur" placeholder="è¾“å…¥å€¼" />
                    <view wx:if="{{!attr.locked}}" class="attr-delete-btn" bindtap="onDeleteAppearanceAttr" data-index="{{attrIdx}}">Ã—</view>
                  </block>
                  <block wx:else>
                    <view class="attr-color-dot custom-dot"></view>
                    <text class="attr-label">{{attr.label}}</text>
                    <text class="attr-value">{{attr.value}}</text>
                  </block>
                </view>
              </block>
            </view>
            <view class="appearance-detail-wrap">
              <block wx:if="{{editingSection === 'appearance'}}"><textarea class="appearance-detail-input input-paragraph" value="{{character.appearance.detail}}" data-path="appearance.detail" bindinput="onFieldInput" placeholder="è¯¦ç»†å¤–è§‚æè¿°" /></block>
              <text wx:else class="appearance-detail">{{character.appearance.detail}}</text>
            </view>
          </view>
          
          <view class="section-divider"></view>
          
          <!-- æ€§æ ¼æè¿° -->
          <view class="info-section">
            <view class="section-header">
              <view class="section-title">æ€§æ ¼æè¿°</view>
              <view class="section-edit-btn" bindtap="onToggleEdit" data-section="personality">{{editingSection === 'personality' ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘'}}</view>
            </view>
            <view class="section-content">
              <block wx:if="{{editingSection === 'personality'}}"><textarea class="long-text-input input-paragraph" value="{{character.personality}}" data-path="personality" bindinput="onFieldInput" placeholder="è¯·è¾“å…¥æ€§æ ¼æè¿°" /></block>
              <text wx:else class="long-text">{{character.personality}}</text>
            </view>
          </view>
          
          <view class="section-divider"></view>
          
          <!-- è§’è‰²èƒŒæ™¯ -->
          <view class="info-section">
            <view class="section-header">
              <view class="section-title">è§’è‰²èƒŒæ™¯</view>
              <view class="section-edit-btn" bindtap="onToggleEdit" data-section="backstory">{{editingSection === 'backstory' ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘'}}</view>
            </view>
            <view class="section-content">
              <block wx:if="{{editingSection === 'backstory'}}"><textarea class="long-text-input input-paragraph" value="{{character.backstory}}" data-path="backstory" bindinput="onFieldInput" placeholder="è¯·è¾“å…¥è§’è‰²èƒŒæ™¯" /></block>
              <text wx:else class="long-text">{{character.backstory}}</text>
            </view>
          </view>
          
          <!-- æ•…äº‹çº¿ï¼ˆå¯é€‰ï¼‰ -->
          <view class="section-divider"></view>
          <view class="info-section">
            <view class="section-header">
              <view class="section-title">æ•…äº‹çº¿</view>
              <view class="section-edit-btn" bindtap="onToggleEdit" data-section="storyline">{{editingSection === 'storyline' ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘'}}</view>
            </view>
            <view class="section-content">
              <block wx:if="{{editingSection === 'storyline'}}"><textarea class="long-text-input input-paragraph" value="{{character.storyline}}" data-path="storyline" bindinput="onFieldInput" placeholder="è¯·è¾“å…¥æ•…äº‹çº¿" /></block>
              <text wx:else class="long-text">{{character.storyline || 'æš‚æ— æ•…äº‹çº¿ï¼Œç‚¹å‡»ç¼–è¾‘æ·»åŠ '}}</text>
            </view>
          </view>
          
          <!-- ç‰¹æ®Šèƒ½åŠ›ï¼ˆå¯é€‰ï¼‰ -->
          <block wx:if="{{character.abilities && character.abilities.length > 0}}">
            <view class="section-divider"></view>
            <view class="info-section">
              <view class="section-header">
                <view class="section-title">ç‰¹æ®Šèƒ½åŠ›</view>
                <view class="section-edit-btn" bindtap="onToggleEdit" data-section="abilities">{{editingSection === 'abilities' ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘'}}</view>
              </view>
              <view class="ability-list">
                <view wx:for="{{character.abilities}}" wx:key="name" class="ability-item">
                  <block wx:if="{{editingSection === 'abilities'}}">
                    <input class="ability-input input-long" value="{{item.name}}" data-path="abilities" data-index="{{index}}" data-subfield="name" bindinput="onFieldInput" placeholder="èƒ½åŠ›åç§°" />
                    <textarea class="ability-desc-input input-paragraph" value="{{item.description}}" data-path="abilities" data-index="{{index}}" data-subfield="description" bindinput="onFieldInput" placeholder="èƒ½åŠ›æè¿°" />
                  </block>
                  <block wx:else>
                    <text class="ability-name">{{item.name}}</text>
                    <text class="ability-desc">{{item.description}}</text>
                  </block>
                </view>
              </view>
            </view>
          </block>
          
          <!-- å…³ç³»ç½‘ï¼ˆå¯é€‰ï¼‰ -->
          <block wx:if="{{character.relationships && character.relationships.length > 0}}">
            <view class="section-divider"></view>
            <view class="info-section">
              <view class="section-header">
                <view class="section-title">å…³ç³»ç½‘</view>
                <view class="section-edit-btn" bindtap="onToggleEdit" data-section="relationships">{{editingSection === 'relationships' ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘'}}</view>
              </view>
              <view class="relationship-list">
                <view wx:for="{{character.relationships}}" wx:key="character" class="relationship-item">
                  <block wx:if="{{editingSection === 'relationships'}}">
                    <input class="rel-input input-short {{focusedInputPath === 'relationships-' + index + '-character' ? 'input-focused' : ''}}" value="{{item.character}}" data-path="relationships" data-index="{{index}}" data-subfield="character" bindinput="onFieldInput" bindfocus="onInputFocus" bindblur="onInputBlur" placeholder="è§’è‰²" />
                    <text class="rel-arrow">â†’</text>
                    <input class="rel-input flex-1 input-long" value="{{item.relation}}" data-path="relationships" data-index="{{index}}" data-subfield="relation" bindinput="onFieldInput" placeholder="å…³ç³»" />
                  </block>
                  <block wx:else>
                    <text class="rel-character">{{item.character}}</text>
                    <text class="rel-arrow">â†’</text>
                    <text class="rel-desc">{{item.relation}}</text>
                  </block>
                </view>
              </view>
            </view>
          </block>
          
          <!-- æ€§æ ¼å…­ç»´å›¾ -->
          <block wx:if="{{character.radar}}">
            <view class="section-divider"></view>
            <view class="info-section">
              <view class="section-header">
                <view class="section-title">æ€§æ ¼å…­ç»´å›¾</view>
                <view class="section-edit-btn" bindtap="onToggleEdit" data-section="radar">{{editingSection === 'radar' ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘'}}</view>
              </view>
              <view class="radar-section">
                <canvas type="2d" id="radarCanvas" class="radar-canvas"></canvas>
                <view class="radar-legends {{editingSection === 'radar' ? 'radar-legends-visible' : ''}}">
                  <view class="radar-legend-item">
                    <text class="legend-label">å¤–å‘åº¦</text>
                    <block wx:if="{{editingSection === 'radar'}}"><view class="radar-input-wrap"><input class="radar-input input-number" type="number" value="{{character.radar.extroversion}}" data-path="radar.extroversion" bindinput="onFieldInput" placeholder="0-100" /><text class="radar-hint">/100</text></view></block>
                    <text wx:else class="legend-value">{{character.radar.extroversion}}/100</text>
                  </view>
                  <view class="radar-legend-item">
                    <text class="legend-label">ç†æ™ºåº¦</text>
                    <block wx:if="{{editingSection === 'radar'}}"><view class="radar-input-wrap"><input class="radar-input input-number" type="number" value="{{character.radar.rationality}}" data-path="radar.rationality" bindinput="onFieldInput" placeholder="0-100" /><text class="radar-hint">/100</text></view></block>
                    <text wx:else class="legend-value">{{character.radar.rationality}}/100</text>
                  </view>
                  <view class="radar-legend-item">
                    <text class="legend-label">å–„è‰¯åº¦</text>
                    <block wx:if="{{editingSection === 'radar'}}"><view class="radar-input-wrap"><input class="radar-input input-number" type="number" value="{{character.radar.kindness}}" data-path="radar.kindness" bindinput="onFieldInput" placeholder="0-100" /><text class="radar-hint">/100</text></view></block>
                    <text wx:else class="legend-value">{{character.radar.kindness}}/100</text>
                  </view>
                  <view class="radar-legend-item">
                    <text class="legend-label">èƒ†è¯†åº¦</text>
                    <block wx:if="{{editingSection === 'radar'}}"><view class="radar-input-wrap"><input class="radar-input input-number" type="number" value="{{character.radar.courage}}" data-path="radar.courage" bindinput="onFieldInput" placeholder="0-100" /><text class="radar-hint">/100</text></view></block>
                    <text wx:else class="legend-value">{{character.radar.courage}}/100</text>
                  </view>
                  <view class="radar-legend-item">
                    <text class="legend-label">å¼€æ”¾åº¦</text>
                    <block wx:if="{{editingSection === 'radar'}}"><view class="radar-input-wrap"><input class="radar-input input-number" type="number" value="{{character.radar.openness}}" data-path="radar.openness" bindinput="onFieldInput" placeholder="0-100" /><text class="radar-hint">/100</text></view></block>
                    <text wx:else class="legend-value">{{character.radar.openness}}/100</text>
                  </view>
                  <view class="radar-legend-item">
                    <text class="legend-label">è´£ä»»æ„Ÿ</text>
                    <block wx:if="{{editingSection === 'radar'}}"><view class="radar-input-wrap"><input class="radar-input input-number" type="number" value="{{character.radar.responsibility}}" data-path="radar.responsibility" bindinput="onFieldInput" placeholder="0-100" /><text class="radar-hint">/100</text></view></block>
                    <text wx:else class="legend-value">{{character.radar.responsibility}}/100</text>
                  </view>
                </view>
              </view>
            </view>
          </block>
        </view>
      </view>
      </block>

      <block wx:elif="{{activeTab === 'gallery'}}">
        <view class="gallery-panel">
          <view class="gallery-grid">
            <block wx:for="{{galleryImages}}" wx:key="*this">
              <view class="gallery-item">
                <view wx:if="{{isGalleryDeleteMode}}" class="gallery-delete-btn" catchtap="onGalleryDeleteTap" data-index="{{index}}">
                  <text class="gallery-delete-icon">Ã—</text>
                </view>
                <image class="gallery-image" src="{{item}}" mode="widthFix" data-url="{{item}}" bindtap="onPreviewGalleryImage" bindlongpress="onGalleryLongPress" />
              </view>
            </block>
            <view class="gallery-add" bindtap="onAddGalleryImage">
              <text class="gallery-add-icon">+</text>
            </view>
          </view>
          <view class="gallery-tip">æœ€å¤šä¸Šä¼  20 å¼ å›¾ç‰‡ï¼Œé•¿æŒ‰è¿›å…¥åˆ é™¤æ¨¡å¼</view>
          <view wx:if="{{isGalleryDeleteMode}}" class="gallery-exit-edit" bindtap="onExitGalleryDeleteMode">é€€å‡ºç¼–è¾‘</view>
        </view>
      </block>
    </block>
    
    <!-- åº•éƒ¨å ä½ -->
    <view class="bottom-placeholder"></view>
  </scroll-view>
  
  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="action-bar" wx:if="{{!loading}}">
    <view class="tab-item" bindtap="onContinueDesign">
      <view class="tab-text">ç»§ç»­è®¾è®¡</view>
    </view>
    <view class="tab-item" bindtap="onExport">
      <view class="tab-text">å¯¼å‡ºä½œå“</view>
    </view>
  </view>

  <view class="save-tip {{saveTipVisible ? 'save-tip--show' : ''}} {{readonly ? 'save-tip--readonly' : ''}}">
    {{saveTipText}}
  </view>
</view>
