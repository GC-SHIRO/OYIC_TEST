# Oäº¿C â€” AI åŸåˆ›è§’è‰²åˆ›ä½œåŠ©æ‰‹

> åŸºäºå¾®ä¿¡å°ç¨‹åº + äº‘å¼€å‘ + Dify AI Agent çš„åŸåˆ›è§’è‰² (OC) åˆ›ä½œçµæ„ŸåŠ©æ‰‹ã€‚
> è§£å†³ ACGN çˆ±å¥½è€…åœ¨æ„æ€è§’è‰²æ—¶æ€ç»´é›¶æ•£ã€é€»è¾‘ç®€å•ç­‰ç—›ç‚¹ï¼Œé€šè¿‡ AI å¯¹è¯å¼•å¯¼ç”¨æˆ·æ•´ç†çµæ„Ÿï¼Œæœ€ç»ˆç”Ÿæˆç»“æ„åŒ–çš„ä¸“ä¸šè§’è‰²ä¿¡æ¯å¡ã€‚

---

## ç›®å½•

- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
- [é¡µé¢è¯´æ˜](#é¡µé¢è¯´æ˜)
- [æœåŠ¡å±‚è®¾è®¡](#æœåŠ¡å±‚è®¾è®¡)
- [äº‘å‡½æ•°](#äº‘å‡½æ•°)
- [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
- [UI / è®¾è®¡è§„èŒƒ](#ui--è®¾è®¡è§„èŒƒ)
- [å¼€å‘ç¯å¢ƒæ­å»º](#å¼€å‘ç¯å¢ƒæ­å»º)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [å¾…å®Œæˆäº‹é¡¹](#å¾…å®Œæˆäº‹é¡¹)

---

## æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| å‰ç«¯æ¡†æ¶ | å¾®ä¿¡å°ç¨‹åº (TypeScript) | `glass-easel` ç»„ä»¶æ¡†æ¶ï¼Œ`lazyCodeLoading` |
| UI ç»„ä»¶åº“ | TDesign Miniprogram v1.12+ | npm æ„å»ºè‡³ `miniprogram_npm/` |
| åç«¯ | å¾®ä¿¡äº‘å¼€å‘ (CloudBase) | äº‘å‡½æ•° + äº‘æ•°æ®åº“ + äº‘å­˜å‚¨ |
| AI å¼•æ“ | Dify (SSE æµå¼) | é€šè¿‡ `difyChat` äº‘å‡½æ•°å®‰å…¨ä»£ç†è°ƒç”¨ |
| ç±»å‹ç³»ç»Ÿ | TypeScript (ES2020, strict) | `tsconfig.json` å…¨é‡ä¸¥æ ¼æ¨¡å¼ |
| æ„å»º | å¾®ä¿¡å¼€å‘è€…å·¥å…·å†…ç½® TS ç¼–è¯‘å™¨æ’ä»¶ | `useCompilerPlugins: ["typescript"]` |

---

## é¡¹ç›®ç»“æ„

```
miniprogram-1/
â”œâ”€â”€ package.json                           # æ ¹ä¾èµ–ï¼ˆtdesign-miniprogramï¼‰
â”œâ”€â”€ project.config.json                    # å°ç¨‹åºé¡¹ç›®é…ç½®ï¼ˆappidã€äº‘ç¯å¢ƒã€ç¼–è¯‘é€‰é¡¹ï¼‰
â”œâ”€â”€ tsconfig.json                          # TypeScript ç¼–è¯‘é…ç½®
â”‚
â”œâ”€â”€ cloudfunctions/                        # â˜ï¸ äº‘å‡½æ•°ï¼ˆNode.jsï¼‰
â”‚   â”œâ”€â”€ login/                             #    ç”¨æˆ·ç™»å½• / è‡ªåŠ¨æ³¨å†Œ
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”œâ”€â”€ difyChat/                          #    Dify API ä»£ç†ï¼ˆSSE æµå¼ï¼‰
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”œâ”€â”€ characterCard/                     #    è§’è‰²å¡ CRUD
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â””â”€â”€ updateUser/                        #    æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆæ˜µç§°/å¤´åƒ/ç­¾åï¼‰
â”‚       â””â”€â”€ index.js
â”‚
â”œâ”€â”€ miniprogram/                           # ğŸ“± å°ç¨‹åºå‰ç«¯
â”‚   â”œâ”€â”€ app.json                           #    å…¨å±€é…ç½®ï¼ˆé¡µé¢è·¯ç”±ã€TabBarã€çª—å£ï¼‰
â”‚   â”œâ”€â”€ app.ts                             #    å…¥å£æ–‡ä»¶ï¼ˆäº‘å¼€å‘åˆå§‹åŒ–ã€ç™»å½•çŠ¶æ€æ£€æŸ¥ï¼‰
â”‚   â”œâ”€â”€ app.wxss                           #    å…¨å±€æ ·å¼ï¼ˆCSS å˜é‡ã€å­—ä½“ã€é€šç”¨ç±»ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ home/                          #    ğŸ  é¦–é¡µ â€” è§’è‰²å¡ä¸­å¿ƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ home.ts                    #        æ¨ªå‘æ»šåŠ¨åˆ—è¡¨ã€äº‘ç«¯/æœ¬åœ°æ•°æ®åŠ è½½
â”‚   â”‚   â”‚   â”œâ”€â”€ home.wxml                  #        å¡ç‰‡æ¨¡æ¿ï¼ˆæ–°å»º/æœªå®Œæˆ/å·²å®Œæˆï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ home.wxss                  #        å¡ç‰‡æ ·å¼ã€æ¸å˜èƒŒæ™¯ã€åŠ¨ç”»
â”‚   â”‚   â”‚   â””â”€â”€ home.json                  #        é¡µé¢ç»„ä»¶å£°æ˜
â”‚   â”‚   â”œâ”€â”€ chat/                          #    ğŸ’¬ AI å¯¹è¯ â€” åˆ›å»ºè§’è‰²
â”‚   â”‚   â”‚   â”œâ”€â”€ chat.ts                    #        Dify å¯¹è¯äº¤äº’ã€æ‰“å­—æœºæ•ˆæœã€å¯¹è¯æŒä¹…åŒ–
â”‚   â”‚   â”‚   â”œâ”€â”€ chat.wxml                  #        èŠå¤©æ°”æ³¡ã€è¾“å…¥æ ã€æ‚¬æµ®ç¡®è®¤æŒ‰é’®
â”‚   â”‚   â”‚   â”œâ”€â”€ chat.wxss                  #        æ¶ˆæ¯æ ·å¼ã€é”®ç›˜é€‚é…
â”‚   â”‚   â”‚   â””â”€â”€ chat.json                  #        é¡µé¢ç»„ä»¶å£°æ˜
â”‚   â”‚   â”œâ”€â”€ preview/                       #    ğŸ‘ï¸ é¢„è§ˆ â€” è§’è‰²å¡è¯¦æƒ…
â”‚   â”‚   â”‚   â”œâ”€â”€ preview.ts                 #        è§’è‰²ä¿¡æ¯æ¸²æŸ“ã€Canvas é›·è¾¾å›¾ã€å®Œæˆåˆ›å»º
â”‚   â”‚   â”‚   â”œâ”€â”€ preview.wxml               #        è§’è‰²å…¨å­—æ®µå±•ç¤ºæ¨¡æ¿
â”‚   â”‚   â”‚   â”œâ”€â”€ preview.wxss               #        å¡ç‰‡é¢„è§ˆæ ·å¼
â”‚   â”‚   â”‚   â””â”€â”€ preview.json               #        é¡µé¢ç»„ä»¶å£°æ˜
â”‚   â”‚   â”œâ”€â”€ profile/                       #    ğŸ‘¤ æˆ‘çš„ â€” ç”¨æˆ·ä¸­å¿ƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ profile.ts                 #        äº‘å¼€å‘ç™»å½•/æ³¨å†Œã€ç¼–è¾‘èµ„æ–™ã€æˆ‘çš„ä½œå“
â”‚   â”‚   â”‚   â”œâ”€â”€ profile.wxml               #        ç”¨æˆ·å¤´éƒ¨ã€ä½œå“åˆ—è¡¨ã€èœå•ã€æ³¨å†Œå¼¹çª—
â”‚   â”‚   â”‚   â”œâ”€â”€ profile.wxss               #        ç”¨æˆ·ä¸­å¿ƒæ ·å¼
â”‚   â”‚   â”‚   â””â”€â”€ profile.json               #        é¡µé¢ç»„ä»¶å£°æ˜
â”‚   â”‚   â”œâ”€â”€ index/                         #    ï¼ˆé»˜è®¤æ¨¡æ¿é¡µï¼Œæœªä½¿ç”¨ï¼‰
â”‚   â”‚   â””â”€â”€ logs/                          #    ï¼ˆå¯åŠ¨æ—¥å¿—é¡µï¼Œé»˜è®¤æ¨¡æ¿ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                          #    ğŸ”§ æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ agent.ts                       #        Dify AI å¯¹è¯ & è§’è‰²å¡ç”Ÿæˆï¼ˆJSON è§£æï¼‰
â”‚   â”‚   â”œâ”€â”€ storage.ts                     #        å­˜å‚¨æœåŠ¡ï¼ˆäº‘ç«¯ä¼˜å…ˆ + æœ¬åœ°ç¼“å­˜é™çº§ï¼‰
â”‚   â”‚   â””â”€â”€ user.ts                        #        ç”¨æˆ·æœåŠ¡ï¼ˆç™»å½•/æ³¨å†Œ/èµ„æ–™æ›´æ–°/å¤´åƒä¸Šä¼ ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ character.ts                   #    ğŸ“ è§’è‰²å¡ç±»å‹å®šä¹‰ï¼ˆICharacterCard ç­‰ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ util.ts                        #    æ—¶é—´æ ¼å¼åŒ–å·¥å…·
â”‚   â”‚
â”‚   â”œâ”€â”€ custom-tab-bar/                    #    â¬‡ï¸ è‡ªå®šä¹‰ TabBarï¼ˆå°ç¨‹åºè§„èŒƒç›®å½•ï¼‰
â”‚   â”‚   â”œâ”€â”€ index.ts / .wxml / .wxss / .json
â”‚   â”‚
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ custom-tabbar/                 #    è‡ªå®šä¹‰ TabBar ç»„ä»¶ï¼ˆå¤‡ç”¨å®ç°ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ assets/                            #    é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ icons/
â”‚   â”‚   â””â”€â”€ images/
â”‚   â”‚
â”‚   â””â”€â”€ miniprogram_npm/                   #    npm æ„å»ºäº§ç‰©
â”‚       â””â”€â”€ tdesign-miniprogram/           #        TDesign ç»„ä»¶åº“
â”‚
â”œâ”€â”€ docs/                                  # ğŸ“„ è®¾è®¡æ–‡æ¡£
â”‚   â”œâ”€â”€ prd.md                             #    äº§å“éœ€æ±‚æ–‡æ¡£
â”‚   â”œâ”€â”€ character_card_design.md           #    è§’è‰²å¡æ•°æ®ç»“æ„è®¾è®¡
â”‚   â””â”€â”€ è§’è‰²å¡æ­£å¼æ„å»ºéœ€æ±‚æ–‡æ¡£.md
â”‚
â”œâ”€â”€ prototype/                             # ğŸ¨ åŸå‹ HTMLï¼ˆè®¾è®¡å‚è€ƒï¼‰
â”‚   â”œâ”€â”€ home.html / chat.html / preview.html / profile.html
â”‚
â”œâ”€â”€ test_tool/                             # ğŸ§ª è°ƒè¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_dify.py                       #    Dify API è¿é€šæ€§æµ‹è¯•
â”‚   â””â”€â”€ test_cloud_connectivity.py         #    äº‘å‡½æ•°ç½‘ç»œæµ‹è¯•
â”‚
â””â”€â”€ typings/                               # TypeScript ç±»å‹å£°æ˜
    â”œâ”€â”€ index.d.ts                         #    IAppOption å…¨å±€ç±»å‹
    â””â”€â”€ types/
```

---

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¾®ä¿¡å°ç¨‹åºå‰ç«¯                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Home   â”‚  â”‚   Chat   â”‚  â”‚ Preview  â”‚  â”‚ Profile  â”‚   â”‚
â”‚  â”‚ è§’è‰²å¡åˆ—è¡¨â”‚  â”‚ AI å¯¹è¯  â”‚  â”‚ å¡ç‰‡é¢„è§ˆ â”‚  â”‚ ç”¨æˆ·ä¸­å¿ƒ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â”‚            â”‚             â”‚              â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”     â”‚
â”‚  â”‚              services/ æœåŠ¡å±‚                       â”‚     â”‚
â”‚  â”‚  agent.ts (AIå¯¹è¯)  storage.ts (å­˜å‚¨)  user.ts     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ wx.cloud.callFunction()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¾®ä¿¡äº‘å¼€å‘ CloudBase                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  login   â”‚  â”‚ difyChat â”‚  â”‚character â”‚  â”‚updateUserâ”‚   â”‚
â”‚  â”‚ ç™»å½•æ³¨å†Œ â”‚  â”‚ AI ä»£ç†  â”‚  â”‚  Card    â”‚  â”‚ æ›´æ–°èµ„æ–™ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  äº‘æ•°æ®åº“: users é›†åˆ / characters é›†åˆ            â”‚     â”‚
â”‚  â”‚  äº‘å­˜å‚¨:   avatars/ (ç”¨æˆ·å¤´åƒ)                     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTPS (SSE æµå¼)
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Dify AI API  â”‚
                 â”‚  è§’è‰²åˆ›ä½œåŠ©æ‰‹  â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒæ•°æ®æµï¼š**

1. **åˆ›å»ºè§’è‰²**ï¼šç”¨æˆ·åœ¨ Chat é¡µè¾“å…¥çµæ„Ÿ â†’ `agent.ts` è°ƒç”¨ `difyChat` äº‘å‡½æ•° â†’ äº‘å‡½æ•°å‘èµ· SSE æµå¼è¯·æ±‚åˆ° Dify API â†’ AI å›å¤é€šè¿‡æ‰“å­—æœºæ•ˆæœé€å­—æ˜¾ç¤º
2. **ç”Ÿæˆè§’è‰²å¡**ï¼šç”¨æˆ·ç‚¹å‡»ç¡®è®¤ â†’ å‘é€ `Give_Result` æŒ‡ä»¤ â†’ Dify è¿”å›ç»“æ„åŒ– JSON â†’ `agent.ts` è§£æå¹¶æ ‡å‡†åŒ– â†’ è·³è½¬ Preview é¡µ
3. **æ•°æ®æŒä¹…åŒ–**ï¼šæœ¬åœ°ç¼“å­˜å³æ—¶å†™å…¥ + å¼‚æ­¥äº‘ç«¯åŒæ­¥ï¼ˆ`storage.ts` åŒå†™ç­–ç•¥ï¼‰ï¼Œç½‘ç»œå¼‚å¸¸æ—¶æœ¬åœ°ç¼“å­˜é™çº§å…œåº•

---

## é¡µé¢è¯´æ˜

### ğŸ  é¦–é¡µ (pages/home)

è§’è‰²å¡ç®¡ç†ä¸­å¿ƒï¼Œé‡‡ç”¨å…¨å±æ¨ªå‘æ»šåŠ¨å¡ç‰‡å¸ƒå±€ã€‚

- **å¡ç‰‡ç±»å‹**ï¼šæ–°å»ºå¡ç‰‡ï¼ˆè™šçº¿ + "+" å›¾æ ‡ï¼‰ã€æœªå®Œæˆå¡ç‰‡ï¼ˆç£¨ç ‚é®ç½© + "æœªå®Œæˆ"æ ‡è¯†ï¼‰ã€å·²å®Œæˆå¡ç‰‡ï¼ˆå±•ç¤ºè§’è‰²ä¿¡æ¯ + æ ‡ç­¾ï¼‰
- **æ•°æ®ç­–ç•¥**ï¼š`onShow` æ—¶å…ˆä»æœ¬åœ°ç¼“å­˜å¿«é€Ÿæ¸²æŸ“é¦–å±ï¼Œéšåå¼‚æ­¥ä»äº‘ç«¯æ‹‰å–æœ€æ–°æ•°æ®æ›´æ–°
- **äº¤äº’**ï¼šç‚¹å‡»æœªå®Œæˆå¡ç‰‡ â†’ è·³è½¬ Chat é¡µç»§ç»­ç¼–è¾‘ï¼›ç‚¹å‡»å·²å®Œæˆå¡ç‰‡ â†’ è·³è½¬ Preview é¡µåªè¯»æŸ¥çœ‹
- **ç™»å½•æ£€æŸ¥**ï¼šæ–°å»ºè§’è‰²éœ€å…ˆç™»å½•ï¼Œæœªç™»å½•æ—¶å¼¹çª—å¼•å¯¼è‡³ Profile é¡µ

### ğŸ’¬ AI å¯¹è¯ (pages/chat)

ä»¿ AI èŠå¤©ç•Œé¢ï¼Œä¸ Dify Agent å®æ—¶å¯¹è¯åˆ›å»ºè§’è‰²ã€‚

- **æ¶ˆæ¯ç³»ç»Ÿ**ï¼šç”¨æˆ·æ¶ˆæ¯ / AI æ¶ˆæ¯åŒæ°”æ³¡å¸ƒå±€ï¼Œæ”¯æŒå›¾ç‰‡æ¶ˆæ¯
- **æ‰“å­—æœºæ•ˆæœ**ï¼šAI å›å¤é€å­—æ˜¾ç¤ºï¼ˆ`streamDisplayMessage`ï¼‰ï¼Œå¯éšæ—¶ä¸­æ–­
- **å¯¹è¯æŒä¹…åŒ–**ï¼šå¯¹è¯è®°å½•ä¿å­˜åœ¨æœ¬åœ° Storageï¼Œæ”¯æŒé€€å‡ºåæ¢å¤
- **è§’è‰²å¡ç”Ÿæˆ**ï¼šå³ä¸Šè§’æ‚¬æµ®ç¡®è®¤æŒ‰é’®è§¦å‘ `Give_Result` â†’ Dify è¿”å› JSON â†’ è§£æåè·³è½¬ Preview
- **é”®ç›˜é€‚é…**ï¼šè¾“å…¥æ è·Ÿéšè½¯é”®ç›˜æµ®åŠ¨ï¼Œ`adjust-position: false` + æ‰‹åŠ¨è®¡ç®—åç§»

### ğŸ‘ï¸ é¢„è§ˆ (pages/preview)

è§’è‰²å¡å®Œæ•´ä¿¡æ¯é¢„è§ˆï¼ŒåŒ…å«æ‰€æœ‰ç»“æ„åŒ–å­—æ®µã€‚

- **å±•ç¤ºå†…å®¹**ï¼šåŸºæœ¬ä¿¡æ¯ï¼ˆå§“å/æ€§åˆ«/æ˜Ÿåº§/ç”Ÿæ—¥/ç‰©ç§ï¼‰ã€æ€§æ ¼æ ‡ç­¾ã€å¤–è§‚æè¿°ï¼ˆå‘è‰²/ç³è‰²/è¯¦ç»†ï¼‰ã€æ€§æ ¼æè¿°ã€è§’è‰²èƒŒæ™¯ã€æ•…äº‹çº¿ã€ç‰¹æ®Šèƒ½åŠ›ã€å…³ç³»ç½‘
- **å…­ç»´é›·è¾¾å›¾**ï¼šä½¿ç”¨ Canvas 2D API ç»˜åˆ¶æ€§æ ¼å…­ç»´å›¾ï¼ˆå¤–å‘åº¦/ç†æ™ºåº¦/å–„è‰¯åº¦/èƒ†è¯†åº¦/å¼€æ”¾åº¦/è´£ä»»æ„Ÿï¼‰
- **æ“ä½œæ¨¡å¼**ï¼š
  - ç¼–è¾‘æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼šåº•éƒ¨æ˜¾ç¤º"ç»§ç»­åˆ›ä½œ"ï¼ˆè¿”å› Chatï¼‰+ "å®Œæˆåˆ›å»º"ï¼ˆæ ‡è®°å·²å®Œæˆå¹¶åŒæ­¥äº‘ç«¯ï¼‰
  - åªè¯»æ¨¡å¼ï¼ˆ`readonly=true`ï¼‰ï¼šéšè—åº•éƒ¨æ“ä½œæ 

### ğŸ‘¤ æˆ‘çš„ (pages/profile)

ç”¨æˆ·ä¿¡æ¯ä¸­å¿ƒä¸ä½œå“ç®¡ç†ã€‚

- **ç™»å½•æµç¨‹**ï¼šåŸºäºäº‘å¼€å‘ + `login` äº‘å‡½æ•°çš„å¾®ä¿¡ä¸€é”®ç™»å½•ï¼Œé¦–æ¬¡ç™»å½•å¼¹å‡ºæ³¨å†Œå¼¹çª—ï¼ˆæ”¶é›†å¤´åƒ + æ˜µç§° + ç­¾åï¼‰
- **èµ„æ–™ç¼–è¾‘**ï¼šä¿®æ”¹æ˜µç§°ã€å¤´åƒä¸Šä¼ ï¼ˆäº‘å­˜å‚¨ï¼‰ã€ä¸ªæ€§ç­¾å
- **æˆ‘çš„ä½œå“**ï¼šæ¨ªå‘æ»šåŠ¨å±•ç¤ºå·²å®Œæˆè§’è‰²å¡ï¼Œç‚¹å‡»è·³è½¬ Preview åªè¯»æŸ¥çœ‹
- **åŠŸèƒ½èœå•**ï¼šä½¿ç”¨æŒ‡å—ã€æ„è§åé¦ˆã€ä½™é¢å……å€¼ï¼ˆé¢„ç•™ï¼‰ã€å…³äºã€é€€å‡ºç™»å½•

---

## æœåŠ¡å±‚è®¾è®¡

### agent.ts â€” AI å¯¹è¯æœåŠ¡

è´Ÿè´£ä¸ Dify AI Agent çš„é€šä¿¡ï¼Œ**API å¯†é’¥å®‰å…¨å­˜æ”¾åœ¨äº‘å‡½æ•°ç«¯ï¼Œå‰ç«¯ä¸æš´éœ²ä»»ä½•å¯†é’¥**ã€‚

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `chatWithDify(query, conversationId?)` | å‘é€å¯¹è¯æ¶ˆæ¯ï¼Œè¿”å› AI å›å¤å’Œä¼šè¯ ID |
| `generateCharacterCard(conversationId)` | å‘é€ `Give_Result` è§¦å‘è§’è‰²å¡ç”Ÿæˆï¼Œè§£æè¿”å›çš„ JSON |
| `parseCharacterJSON(text)` | ä» AI å›å¤ä¸­æå– JSONï¼ˆæ”¯æŒ markdown ä»£ç å—ã€Python å•å¼•å·å…¼å®¹ï¼‰ |
| `normalizeCharacterInfo(obj)` | æ ‡å‡†åŒ–å­—æ®µåï¼ˆå…¼å®¹ snake_case / camelCaseï¼‰ |

### storage.ts â€” æ•°æ®å­˜å‚¨æœåŠ¡

**äº‘ç«¯ä¼˜å…ˆ + æœ¬åœ°ç¼“å­˜é™çº§**çš„åŒå±‚å­˜å‚¨ç­–ç•¥ï¼Œæ•°æ®æŒ‰ç”¨æˆ· openId éš”ç¦»ã€‚

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `fetchCharactersFromCloud()` | ä»äº‘ç«¯æ‹‰å–æ‰€æœ‰è§’è‰²å¡ï¼ˆæ ¸å¿ƒï¼‰ï¼ŒåŒæ­¥æ›´æ–°æœ¬åœ°ç¼“å­˜ |
| `fetchCharacterFromCloud(id)` | ä»äº‘ç«¯æ‹‰å–å•ä¸ªè§’è‰²å¡ |
| `saveCharacter(card)` | æœ¬åœ° + äº‘ç«¯åŒå†™ |
| `saveCharacterLocal(card)` | ä»…æœ¬åœ°ä¿å­˜ï¼ˆåˆå§‹è‰ç¨¿ï¼‰ |
| `deleteCharacter(id)` | æœ¬åœ° + äº‘ç«¯åŒåˆ  |
| `getConversation(id)` / `saveConversation(id, msgs)` | å¯¹è¯å†å²ï¼ˆä»…æœ¬åœ°å­˜å‚¨ï¼‰ |
| `getCurrentUserId()` | è·å–å½“å‰ç™»å½•ç”¨æˆ· openId |

### user.ts â€” ç”¨æˆ·æœåŠ¡

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `cloudLogin(nickname?, avatar?)` | è°ƒç”¨ `login` äº‘å‡½æ•°ï¼Œç™»å½• / è‡ªåŠ¨æ³¨å†Œ |
| `updateNickname(name)` | æ›´æ–°æ˜µç§° |
| `updateSignature(sig)` | æ›´æ–°ç­¾å |
| `uploadAvatar(tempPath)` | ä¸Šä¼ å¤´åƒåˆ°äº‘å­˜å‚¨å¹¶æ›´æ–°ç”¨æˆ·è®°å½• |
| `getCloudUserInfo()` | ç›´æ¥æŸ¥è¯¢äº‘æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯ |
| `logout()` / `isLoggedIn()` / `getLocalUserInfo()` | ç™»å½•çŠ¶æ€ç®¡ç† |

---

## äº‘å‡½æ•°

äº‘ç¯å¢ƒ IDï¼š`cloud1-0g88vkjh890eca50`

| äº‘å‡½æ•° | è¶…æ—¶ | è¯´æ˜ |
|--------|------|------|
| **login** | é»˜è®¤ | ç”¨æˆ·ç™»å½• / è‡ªåŠ¨æ³¨å†Œã€‚æŸ¥è¯¢ `users` é›†åˆï¼Œå·²æœ‰ç”¨æˆ·æ›´æ–°ç™»å½•æ—¶é—´ï¼Œæ–°ç”¨æˆ·èµ é€ 10 æ¬¡ä½™é¢ |
| **difyChat** | 120s | Dify API å®‰å…¨ä»£ç†ã€‚æ”¯æŒ `chat`ï¼ˆSSE æµå¼å¯¹è¯ï¼‰å’Œ `ping`ï¼ˆè¿é€šæ€§æµ‹è¯•å« DNS + HTTPS æ£€æµ‹ï¼‰ä¸¤ç§ action |
| **characterCard** | 30s | è§’è‰²å¡ CRUDã€‚æ”¯æŒ `create` / `update` / `get` / `list` / `delete` æ“ä½œï¼Œæ•°æ®å­˜å…¥ `characters` é›†åˆï¼ŒæŒ‰ `_openid` éš”ç¦» |
| **updateUser** | é»˜è®¤ | å¢é‡æ›´æ–°ç”¨æˆ·å­—æ®µï¼ˆnickname / avatar / signatureï¼‰ï¼Œæ“ä½œ `users` é›†åˆ |

### äº‘æ•°æ®åº“é›†åˆ

| é›†åˆ | ä¸»è¦å­—æ®µ | è¯´æ˜ |
|------|----------|------|
| **users** | `_openid`, `nickname`, `avatar`, `signature`, `balance`, `loginCount`, `createdAt` | ç”¨æˆ·ä¿¡æ¯ |
| **characters** | `cardId`, `_openid`, `status`, `conversationId`, `avatar`, `gallery`, `characterInfo`, `createdAt` | è§’è‰²å¡æ•°æ® |

---

## æ•°æ®æ¨¡å‹

### ICharacterCardï¼ˆè§’è‰²å¡å­˜å‚¨ç»“æ„ï¼‰

```typescript
interface ICharacterCard {
  id: string;                    // å¡ç‰‡ IDï¼ˆå‰ç«¯ç”Ÿæˆï¼Œæ—¶é—´æˆ³ + éšæœºä¸²ï¼‰
  createdAt: number;             // åˆ›å»ºæ—¶é—´æˆ³
  updatedAt: number;             // æ›´æ–°æ—¶é—´æˆ³
  creatorId?: string;            // åˆ›å»ºè€… openId
  status: 'completed' | 'incomplete';  // åˆ›å»ºçŠ¶æ€
  conversationId?: string;       // Dify ä¼šè¯ ID
  avatar?: string;               // è§’è‰²å¤´åƒ
  characterInfo: ICharacterInfo; // è§’è‰²å…·ä½“ä¿¡æ¯
}
```

### ICharacterInfoï¼ˆè§’è‰²å…·ä½“ä¿¡æ¯ï¼‰

```typescript
interface ICharacterInfo {
  name: string;                  // å§“å
  gender: string;                // æ€§åˆ«
  birthday?: string;             // ç”Ÿæ—¥
  constellation?: string;        // æ˜Ÿåº§
  species: string;               // ç‰©ç§
  introduction: string;          // ç®€ä»‹
  personalityTags: string[];     // æ€§æ ¼æ ‡ç­¾
  appearance: {                  // å¤–è§‚
    hairColor: string;           //   å‘è‰²
    eyeColor: string;            //   ç³è‰²
    detail: string;              //   è¯¦ç»†æè¿°
  };
  personality: string;           // æ€§æ ¼æè¿°
  backstory: string;             // èƒŒæ™¯æ•…äº‹
  storyline?: string;            // æ•…äº‹çº¿ï¼ˆå¯é€‰ï¼‰
  abilities?: Array<{            // ç‰¹æ®Šèƒ½åŠ›ï¼ˆå¯é€‰ï¼‰
    name: string;
    description: string;
  }>;
  relationships?: Array<{        // å…³ç³»ç½‘ï¼ˆå¯é€‰ï¼‰
    character: string;
    relation: string;
  }>;
  radar: {                       // æ€§æ ¼å…­ç»´å›¾ï¼ˆ0~1ï¼‰
    extroversion: number;        //   å¤–å‘åº¦
    rationality: number;         //   ç†æ™ºåº¦
    kindness: number;            //   å–„è‰¯åº¦
    courage: number;             //   èƒ†è¯†åº¦
    openness: number;            //   å¼€æ”¾åº¦
    responsibility: number;      //   è´£ä»»æ„Ÿ
  };
}
```

---

## UI / è®¾è®¡è§„èŒƒ

### è‰²å½©ä½“ç³»

é‡‡ç”¨é“¶è‰²ç°è°ƒè®¾è®¡è¯­è¨€ï¼Œé€šè¿‡ CSS å˜é‡åœ¨ `app.wxss` ä¸­ç»Ÿä¸€å®šä¹‰ï¼š

| å˜é‡ | è‰²å€¼ | ç”¨é€” |
|------|------|------|
| `--bg` | `#f2f3f5` | é¡µé¢èƒŒæ™¯ |
| `--surface` | `#ffffff` | å¡ç‰‡ / å®¹å™¨è¡¨é¢ |
| `--text` | `#1f2937` | ä¸»æ–‡æœ¬è‰² |
| `--muted` | `#6b7280` | è¾…åŠ©æ–‡æœ¬è‰² |
| `--border` | `#e5e7eb` | è¾¹æ¡†è‰² |
| `--silver-1` ~ `--silver-3` | `#f9fafb` ~ `#cbd5e1` | é“¶ç°æ¸å˜æ¢¯åº¦ |

### å­—ä½“

```css
font-family: "PingFang SC", "MiSans", "Noto Sans SC", "Source Han Sans SC", sans-serif;
```

### å¯¼èˆª

- å…¨å±€ä½¿ç”¨ `navigationStyle: custom` è‡ªå®šä¹‰å¯¼èˆªæ 
- è‡ªå®šä¹‰ TabBar æ‚¬æµ®äºé¡µé¢åº•éƒ¨ï¼Œåœ†è§’èƒ¶å›Šé€ å‹ï¼ˆ`border-radius: 48rpx`ï¼‰ï¼Œåº•éƒ¨ç•™ 32rpx é—´è·
- TabBar ä¸¤ä¸ªå…¥å£ï¼šé¦–é¡µï¼ˆ`home` å›¾æ ‡ï¼‰ã€æˆ‘çš„ï¼ˆ`user` å›¾æ ‡ï¼‰

### å¡ç‰‡æ ·å¼

- åœ†è§’ï¼š`64rpx`ï¼ˆè§’è‰²å¡ï¼‰ã€`48rpx`ï¼ˆTabBarï¼‰
- é˜´å½±ï¼š`0 16rpx 40rpx rgba(17,24,39,0.10)`
- å·²å®Œæˆå¡ç‰‡ï¼šé“¶ç°æ¸å˜ `linear-gradient(160deg, #f9fafb, #e5e7eb, #cbd5e1)`
- æœªå®Œæˆå¡ç‰‡ï¼šç£¨ç ‚é®ç½© `rgba(255,255,255,0.65)` + "æœªå®Œæˆ"æ ‡è¯†
- å¡ç‰‡å°ºå¯¸ï¼š`500rpx Ã— 950rpx`
- å…¥åœºåŠ¨ç”»ï¼š`@keyframes riseIn`ï¼ˆä¸Šæ»‘æ·¡å…¥ï¼‰

### ç»„ä»¶åº“

ä½¿ç”¨ [TDesign å¾®ä¿¡å°ç¨‹åºç»„ä»¶åº“](https://tdesign.tencent.com/miniprogram/getting-started)ï¼Œå¸¸ç”¨ç»„ä»¶ï¼š

`t-icon` Â· `t-button` Â· `t-tag` Â· `t-loading` Â· `t-avatar` Â· `t-cell` Â· `t-cell-group` Â· `t-image` Â· `t-badge` Â· `t-popup` Â· `t-navbar` Â· `t-fab`

---

## å¼€å‘ç¯å¢ƒæ­å»º

### å‰ç½®è¦æ±‚

- [å¾®ä¿¡å¼€å‘è€…å·¥å…·](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)ï¼ˆç¨³å®šç‰ˆï¼‰
- Node.js 16+
- å¾®ä¿¡å°ç¨‹åº AppIDï¼š`wxabc67471e809a0c7`

### å¿«é€Ÿå¼€å§‹

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repo-url>
cd miniprogram-1

# 2. å®‰è£…ä¾èµ–
npm install

# 3. ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·æ‰“å¼€é¡¹ç›®
#    - å¯¼å…¥é¡¹ç›®ç›®å½•ï¼Œå¡«å…¥ AppID
#    - å·¥å…· â†’ æ„å»º npmï¼ˆå°† tdesign-miniprogram æ„å»ºåˆ° miniprogram_npm/ï¼‰

# 4. äº‘å¼€å‘
#    - å¼€é€šäº‘å¼€å‘ç¯å¢ƒï¼ˆç¯å¢ƒ ID: cloud1-0g88vkjh890eca50ï¼‰
#    - ä¸Šä¼ å…¨éƒ¨äº‘å‡½æ•°ï¼ˆå³é”®å„äº‘å‡½æ•°ç›®å½• â†’ ä¸Šä¼ å¹¶éƒ¨ç½²ï¼‰
#    - åˆ›å»ºäº‘æ•°æ®åº“é›†åˆï¼šusersã€characters

# 5. ç¼–è¯‘è¿è¡Œ
#    - åœ¨å¼€å‘è€…å·¥å…·ä¸­ç¼–è¯‘é¢„è§ˆ
```

### npm æ„å»º

é¡¹ç›®ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®š npm æ„å»ºè·¯å¾„ï¼š

```json
// project.config.json
"packNpmManually": true,
"packNpmRelationList": [{
  "packageJsonPath": "./package.json",
  "miniprogramNpmDistDir": "./miniprogram/"
}]
```

ä¿®æ”¹ `package.json` ä¾èµ–åï¼Œéœ€åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­é‡æ–°æ‰§è¡Œ **å·¥å…· â†’ æ„å»º npm**ã€‚

---

## é…ç½®è¯´æ˜

### Dify API é…ç½®

Dify API Key å­˜æ”¾åœ¨ `cloudfunctions/difyChat/index.js` ä¸­ï¼š

```javascript
const DIFY_API_KEY = 'app-xxxxxxxxxxxxxxxx';  // æ›¿æ¢ä¸ºä½ çš„ Dify API Key
const DIFY_BASE_URL = 'https://api.dify.ai/v1';
```

> âš ï¸ API Key ä»…åœ¨äº‘å‡½æ•°ç«¯ä½¿ç”¨ï¼Œå‰ç«¯é€šè¿‡ `wx.cloud.callFunction` é—´æ¥è°ƒç”¨ï¼Œ**ä¸æš´éœ²ä»»ä½•å¯†é’¥**ã€‚

### äº‘å¼€å‘ç¯å¢ƒ

```javascript
// app.ts
wx.cloud.init({
  env: 'cloud1-0g88vkjh890eca50',
  traceUser: true,
});
```

### TypeScript é…ç½®

- ç›®æ ‡ï¼šES2020
- æ¨¡å—ï¼šCommonJS
- å…¨é‡ä¸¥æ ¼æ¨¡å¼ï¼ˆ`strict: true`ï¼‰
- ç±»å‹æ ¹ç›®å½•ï¼š`./typings`

---

## å¾…å®Œæˆäº‹é¡¹

- [ ] æ·»åŠ å®é™…çš„è§’è‰²å¤´åƒå›¾ç‰‡èµ„æº
- [ ] å®ç°èŠå¤©é¡µå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼ˆ`onChooseImage`ï¼‰
- [ ] å¤šè§’è‰²å¡æ¨¡æ¿æ”¯æŒ
- [ ] ä½™é¢å……å€¼ä¸æ¶ˆè´¹é—­ç¯ï¼ˆv2.0ï¼‰
- [ ] è§’è‰²å¡åˆ†äº«åŠŸèƒ½
- [ ] å®Œå–„é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€åé¦ˆ
- [ ] ä½¿ç”¨æŒ‡å— / æ„è§åé¦ˆé¡µé¢å®ç°
