## 计划：Profile 页面兑换码功能

### TL;DR

在个人中心（Profile）页面的菜单列表中新增「兑换码」入口，用户点击后弹出底部输入弹窗，输入兑换码后调用云函数进行校验和兑换。兑换码支持多类型奖励（创作点、角色卡模板、VIP 权益等），采用高级限制规则（新用户专属、指定用户可用、每日限量等）。后台通过独立的管理云函数批量创建和管理兑换码。

用户选择：
- 入口位置：个人中心（Profile）页面菜单列表项
- 管理方式：云函数管理接口
- 兑换类型：多类型兑换（创作点 + 角色卡模板 + VIP 权益等）
- 使用限制：高级限制（每人限用 + 总次数上限 + 过期时间 + 新用户专属 + 指定用户 + 每日限量）

---

### 步骤

#### 一、数据库层 — 新建 `redemption_codes` 集合

在微信云开发控制台创建集合 `redemption_codes`，字段设计如下：

| 字段 | 类型 | 说明 |
|------|------|------|
| `code` | string | 兑换码（唯一索引，大写字母+数字） |
| `rewardType` | string | 奖励类型：`points` / `cardTemplate` / `vip` |
| `rewardValue` | number/object | 奖励值（点数数量 / 模板ID / VIP天数等） |
| `maxUses` | number | 最大总使用次数（-1 = 无限） |
| `usedCount` | number | 已使用次数 |
| `usedBy` | array | 已使用的 openId 列表（防重复） |
| `dailyLimit` | number | 每日兑换上限（-1 = 无限） |
| `dailyUsed` | number | 当日已使用次数 |
| `dailyResetDate` | string | 当日已使用次数的重置日期 |
| `targetUsers` | array | 指定可用用户 openId 列表（空 = 全部可用） |
| `newUserOnly` | boolean | 是否仅新用户可用 |
| `expiresAt` | date | 过期时间（null = 永不过期） |
| `status` | string | `active` / `disabled` |
| `batchId` | string | 批次 ID（方便批量管理） |
| `description` | string | 兑换码描述（展示给用户的文案） |
| `createdAt` | date | 创建时间 |

需要创建索引：`code`（唯一索引）、`batchId`、`status`

同时更新 [docs/database_schema.md](docs/database_schema.md) 添加此集合的文档。

#### 二、云函数层 — 新建 `redeem` 云函数

新建 `cloudfunctions/redeem/` 目录，包含 `index.js`、`package.json`、`config.json`。

**Action: `redeem`（用户兑换）**
1. 接收参数：`event.code`（兑换码字符串）
2. 获取当前用户 `openId`
3. 查询 `redemption_codes` 集合，校验：
   - 兑换码是否存在且 `status === 'active'`
   - 是否已过期（`expiresAt`）
   - 用户是否已兑换过（`usedBy` 数组中检查 openId）
   - 总使用次数是否已满（`usedCount < maxUses`）
   - 每日限量检查（`dailyLimit`、`dailyUsed`、`dailyResetDate`）
   - 新用户专属检查（`newUserOnly`，通过 `users` 表的 `createdAt` 判断）
   - 指定用户检查（`targetUsers` 是否包含当前 openId）
4. 根据 `rewardType` 分发处理：
   - `points`：事务中更新 `users.balance` + 写入 `usage_logs`（type: `'redeem'`）+ 更新 `redemption_codes`（`usedCount++`、`usedBy.push(openId)`、`dailyUsed++`）
   - `cardTemplate`：将预设角色卡模板复制到用户的 `characters` 集合
   - `vip`：更新 `users` 表的 VIP 相关字段（需扩展 users 集合）
5. 返回格式：`{ code: 0, message: 'ok', data: { rewardType, rewardValue, description } }`

**Action: `admin_create`（管理员批量创建兑换码）**
1. 校验调用者权限（通过预设管理员 openId 列表或密钥校验）
2. 接收参数：`batchId`、`count`（批量数量）、`rewardType`、`rewardValue`、各类限制配置
3. 批量生成随机兑换码（8-12 位大写字母 + 数字）
4. 批量写入 `redemption_codes`
5. 返回所有生成的兑换码列表

**Action: `admin_list`（管理员查询兑换码）**
1. 权限校验
2. 按 `batchId`、`status` 等条件查询，支持分页

**Action: `admin_disable`（管理员禁用兑换码）**
1. 权限校验
2. 更新指定兑换码的 `status` 为 `disabled`（支持按批次批量禁用）

#### 三、前端个人中心 — 菜单入口 + 兑换弹窗

**3.1 修改 [miniprogram/pages/profile/profile.json](miniprogram/pages/profile/profile.json)**
- 新增组件注册：`t-input`、`t-button`（页面已有 `t-popup`、`t-icon` 等组件）

**3.2 修改 [miniprogram/pages/profile/profile.wxml](miniprogram/pages/profile/profile.wxml)**
- 在菜单列表（`menu-section`）中，「余额充值」与「关于我们」之间新增「兑换码」菜单项：
  - 图标使用 `gift` 图标，与其他菜单项保持一致的布局风格
  - 副标题文案："输入兑换码领取奖励"
  - 点击事件绑定 `onRedeemTap`
- 添加 `t-popup` 弹窗组件（从底部弹出，复用页面已有的 popup 模式），内含：
  - 标题区：标题"兑换码"+ 关闭按钮
  - 输入区：`input` 组件，placeholder "请输入兑换码"，样式参考注册弹窗的 `nickname-input`
  - 操作区：确认兑换按钮（带 loading 状态）
  - 结果反馈：兑换成功时显示奖励信息，失败时显示错误原因

**3.3 修改 [miniprogram/pages/profile/profile.ts](miniprogram/pages/profile/profile.ts)**
- 新增 `data` 字段：`redeemPopupVisible`、`redeemCode`、`redeemLoading`
- 新增方法 `onRedeemTap()`：点击菜单项，先检查登录状态（参考页面已有的 `isLoggedIn` 判断模式），未登录则提示先登录，已登录则打开兑换弹窗
- 新增方法 `onRedeemCodeInput(e)`：绑定输入框值变化
- 新增方法 `onRedeemSubmit()`：
  1. 校验输入不为空
  2. 设置 `redeemLoading: true`
  3. 调用 `wx.cloud.callFunction({ name: 'redeem', data: { action: 'redeem', code: this.data.redeemCode } })`
  4. 根据返回结果显示成功/失败的 Toast/Message
  5. 成功时关闭弹窗，刷新余额展示（调用 `loadBalanceOverview()`）
- 新增方法 `onRedeemPopupClose()`：关闭弹窗，清空输入
- 在 `onMenuTap` 的 switch 中新增 `case 'redeem'` 分支（或直接使用独立的 `onRedeemTap` 事件）

**3.4 修改 [miniprogram/pages/profile/profile.wxss](miniprogram/pages/profile/profile.wxss)**
- 兑换弹窗样式：底部弹出，圆角顶部，内部表单间距（可复用注册弹窗 `register-popup` 的整体风格）
- 兑换码输入框样式（复用 `nickname-input` 风格）
- 兑换按钮样式（复用 `register-confirm-btn` 风格）

#### 四、usage_logs 兼容 — 新增 `redeem` 类型

**4.1 修改 [miniprogram/pages/usage/](miniprogram/pages/usage/) 账单页面**
- 在账单列表中识别并展示 `type: 'redeem'` 的记录
- 显示文案如"兑换码奖励"，图标区分

**4.2 更新 [cloudfunctions/billing/index.js](cloudfunctions/billing/index.js)**
- 在 `usage` action 中确保能正确查询和返回 `type: 'redeem'` 的记录

#### 五、文档更新

**5.1 更新 [docs/database_schema.md](docs/database_schema.md)**
- 新增 `redemption_codes` 集合定义
- `usage_logs.type` 枚举新增 `redeem`

**5.2 更新 [docs/pay_system.md](docs/pay_system.md)**
- 新增兑换码系统章节：兑换码规则、奖励类型、限制规则

---

### 验证

1. **单元测试**：在 `test_tool/` 下新建 `test_redeem.py`，测试云函数的各类校验逻辑（正常兑换、重复兑换、过期、限量等）
2. **手动测试流程**：
   - 在云开发控制台手动 / 通过 `admin_create` 创建测试兑换码
   - 在个人中心页面点击「兑换码」菜单项，输入兑换码
   - 验证创作点到账（余额增加、余额卡片刷新）
   - 验证重复兑换被拒绝
   - 验证过期兑换码被拒绝
   - 验证新用户专属 / 指定用户限制
   - 验证每日限量逻辑
   - 在账单页面查看兑换记录
3. **边界情况**：
   - 未登录用户点击兑换按钮 → 引导登录
   - 输入空值或无效格式 → 前端校验提示
   - 网络异常 → 错误提示 + 重试
   - 并发兑换（事务保障原子性）

---

### 决策

- **入口位置**：放置在个人中心（Profile）页面的菜单列表中（「余额充值」与「关于我们」之间），与充值入口相邻，符合用户对"资产/权益"类操作的心理预期，同时复用已有的菜单布局和弹窗组件，开发成本低
- **独立云函数**：新建 `redeem` 云函数而非放入 `billing` 中，因为兑换码逻辑较复杂且包含管理功能，职责分离更好维护
- **多类型奖励架构**：`rewardType` + `rewardValue` 的设计可扩展，未来新增奖励类型只需增加处理分支
- **高级限制规则**：在 `redemption_codes` 集合中直接存储限制条件，云函数中逐项校验，避免外部配置依赖
- **管理员认证**：首期通过硬编码管理员 openId 列表实现权限校验，后续可升级为独立的管理后台