# 对话复制和重新发送功能规划

## 功能概述

为聊天页面增添长按消息的交互功能，支持复制消息内容和重新发送用户消息。

---

## 交互设计

### 1. 用户消息长按交互

**触发方式**：长按用户发送的消息气泡（`role === 'user'`）

**动画效果**：
- 消息气泡略微缩小（scale: 0.95）
- 添加过渡动画（transition: transform 0.2s ease）

**悬浮按钮**：
- 位置：消息气泡下方居中
- 样式：白底圆形图标按钮，带阴影
- 按钮组：
  - **复制按钮**：复制图标，点击后复制消息文本到剪贴板
  - **重新发送按钮**：刷新/发送图标，点击后将消息内容填入输入框并唤起键盘

### 2. AI 消息长按交互

**触发方式**：长按 AI 发送的消息气泡（`role === 'ai'`）

**动画效果**：
- 同用户消息，气泡略微缩小（scale: 0.95）

**悬浮按钮**：
- 位置：消息气泡下方居中
- 样式：白底圆形图标按钮
- 按钮组：
  - **复制按钮**：仅复制功能

### 3. 取消选中状态

**触发方式**：
- 点击屏幕其他位置（遮罩层）
- 点击消息列表空白区域
- 点击其他消息

**效果**：
- 当前选中消息恢复原状（scale: 1）
- 悬浮按钮消失

---

## 数据结构变更

### Page Data 新增字段

```typescript
data: {
  // ... 原有字段
  
  // 当前选中的消息ID
  selectedMessageId: string | null;
  
  // 是否显示操作菜单
  showActionMenu: boolean;
  
  // 操作菜单位置（用于定位）
  actionMenuPosition: {
    top: number;
    left: number;
  };
}
```

### IMessage 扩展（可选）

```typescript
interface IMessage {
  // ... 原有字段
  
  // 是否处于选中状态（用于添加选中样式）
  isSelected?: boolean;
}
```

---

## 页面结构变更

### chat.wxml 修改

```xml
<!-- 消息列表 - 添加长按事件 -->
<view 
  wx:for="{{messages}}" 
  wx:key="id" 
  id="msg-{{item.id}}"
  class="message {{item.role === 'ai' ? 'message-ai' : 'message-user'}} {{item.animate ? 'message-animate' : ''}} {{item.id === selectedMessageId ? 'message-selected' : ''}}"
  bindlongpress="onMessageLongPress"
  data-message-id="{{item.id}}"
  data-role="{{item.role}}"
  data-content="{{item.content}}"
>
  <!-- ... 原有消息内容 ... -->
</view>

<!-- 遮罩层 - 点击取消选中 -->
<view 
  class="action-mask"
  wx:if="{{showActionMenu}}"
  bindtap="onCancelSelect"
></view>

<!-- 操作菜单悬浮层 -->
<view 
  class="action-menu"
  wx:if="{{showActionMenu}}"
  style="top: {{actionMenuPosition.top}}px; left: {{actionMenuPosition.left}}px;"
>
  <!-- 复制按钮 - 用户和AI消息都显示 -->
  <view class="action-btn" bindtap="onCopyMessage">
    <t-icon name="copy" size="40rpx" color="#374151" />
  </view>
  
  <!-- 重新发送按钮 - 仅用户消息显示 -->
  <view 
    class="action-btn" 
    bindtap="onResendMessage"
    wx:if="{{selectedMessageRole === 'user'}}"
  >
    <t-icon name="refresh" size="40rpx" color="#374151" />
  </view>
</view>
```

---

## 样式设计

### chat.wxss 新增样式

```css
/* 消息选中状态 */
.message-selected .message-bubble {
  transform: scale(0.95);
  transition: transform 0.2s ease;
  box-shadow: 0 4rpx 16rpx rgba(0, 0, 0, 0.1);
}

/* 遮罩层 */
.action-mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 150;
  background: transparent;
}

/* 操作菜单容器 */
.action-menu {
  position: fixed;
  z-index: 200;
  display: flex;
  gap: 32rpx;
  padding: 16rpx 24rpx;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 48rpx;
  box-shadow: 0 8rpx 32rpx rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(10rpx);
  transform: translateX(-50%);
  animation: menuPop 0.2s ease;
}

@keyframes menuPop {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(10rpx) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0) scale(1);
  }
}

/* 操作按钮 */
.action-menu .action-btn {
  width: 88rpx;
  height: 88rpx;
  border-radius: 50%;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.08);
  transition: all 0.15s ease;
}

.action-menu .action-btn:active {
  transform: scale(0.9);
  background: #f3f4f6;
}
```

---

## 事件处理逻辑

### chat.ts 新增方法

```typescript
Page({
  data: {
    // ... 原有数据
    selectedMessageId: null as string | null,
    selectedMessageRole: null as 'user' | 'ai' | null,
    selectedMessageContent: '',
    showActionMenu: false,
    actionMenuPosition: { top: 0, left: 0 },
  },

  /**
   * 长按消息事件
   */
  onMessageLongPress(e: WechatMiniprogram.BaseEvent) {
    const { messageId, role, content } = e.currentTarget.dataset;
    
    // 获取消息元素位置
    const query = wx.createSelectorQuery().in(this);
    query.select(`#msg-${messageId}`).boundingClientRect((rect) => {
      if (rect) {
        this.setData({
          selectedMessageId: messageId,
          selectedMessageRole: role,
          selectedMessageContent: content,
          showActionMenu: true,
          actionMenuPosition: {
            top: rect.bottom + 10, // 消息底部下方 10px
            left: rect.left + rect.width / 2, // 消息水平居中
          },
        });
      }
    }).exec();
  },

  /**
   * 取消选中
   */
  onCancelSelect() {
    this.setData({
      selectedMessageId: null,
      selectedMessageRole: null,
      selectedMessageContent: '',
      showActionMenu: false,
    });
  },

  /**
   * 复制消息
   */
  onCopyMessage() {
    const { selectedMessageContent } = this.data;
    if (selectedMessageContent) {
      wx.setClipboardData({
        data: selectedMessageContent,
        success: () => {
          wx.showToast({
            title: '已复制',
            icon: 'success',
            duration: 1500,
          });
        },
      });
    }
    this.onCancelSelect();
  },

  /**
   * 重新发送消息
   */
  onResendMessage() {
    const { selectedMessageContent } = this.data;
    if (selectedMessageContent) {
      this.setData({
        inputValue: selectedMessageContent,
      }, () => {
        // 聚焦输入框并唤起键盘
        const query = wx.createSelectorQuery().in(this);
        query.select('.chat-input').node((res) => {
          if (res && res.node) {
            res.node.focus();
          }
        }).exec();
      });
    }
    this.onCancelSelect();
  },
});
```

---

## 实现步骤

### 步骤1：修改 chat.wxml
- [ ] 为消息项添加 `bindlongpress` 事件绑定
- [ ] 添加 `data-message-id`、`data-role`、`data-content` 数据属性
- [ ] 添加选中状态样式类 `message-selected`
- [ ] 添加遮罩层 `action-mask`
- [ ] 添加操作菜单悬浮层 `action-menu`

### 步骤2：修改 chat.wxss
- [ ] 添加 `.message-selected` 选中样式
- [ ] 添加 `.action-mask` 遮罩层样式
- [ ] 添加 `.action-menu` 操作菜单样式
- [ ] 添加 `.action-btn` 按钮样式
- [ ] 添加菜单弹出动画 `menuPop`

### 步骤3：修改 chat.ts
- [ ] 在 data 中添加 `selectedMessageId`、`selectedMessageRole`、`selectedMessageContent`、`showActionMenu`、`actionMenuPosition`
- [ ] 实现 `onMessageLongPress` 方法
- [ ] 实现 `onCancelSelect` 方法
- [ ] 实现 `onCopyMessage` 方法
- [ ] 实现 `onResendMessage` 方法

### 步骤4：测试验证
- [ ] 测试长按用户消息显示两个按钮
- [ ] 测试长按 AI 消息只显示复制按钮
- [ ] 测试复制功能正常工作
- [ ] 测试重新发送功能填入输入框并唤起键盘
- [ ] 测试点击其他位置取消选中状态
- [ ] 测试快速连续长按不同消息的行为

---

## 注意事项

1. **性能优化**：使用 `wx.createSelectorQuery` 获取位置时，注意在页面卸载时清理
2. **边界处理**：操作菜单超出屏幕边界时，需要调整位置
3. **兼容性**：确保在 iOS 和 Android 上长按事件都能正常触发
4. **无障碍**：考虑为视障用户添加语音提示
5. **冲突处理**：确保与现有的点击事件（如图片预览）不冲突

---

## 视觉参考

```
用户消息长按后：
┌─────────────────┐
│   消息气泡(缩小)  │
└─────────────────┘
       ↓
    ┌─────┐ ┌─────┐
    │ 复制 │ │重发 │
    └─────┘ └─────┘

AI消息长按后：
┌─────────────────┐
│   消息气泡(缩小)  │
└─────────────────┘
       ↓
    ┌─────┐
    │ 复制 │
    └─────┘
```
